<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—…ë¡œë“œ íŒŒì¼ ë‹¨ì–´ í…ŒìŠ¤íŠ¸</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Nanum+Gothic:wght@400;700&display=swap');
        body {
            font-family: 'Nanum Gothic', 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px #106f40;
            position: relative;
            top: 0;
        }
        .btn-primary:active {
            top: 2px;
            box-shadow: 0 2px #106f40;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        /* ë””ë²„ê·¸ ë¡œê·¸ ì„¹ì…˜ì„ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹ë‹ˆë‹¤. */
        #debugLogSection {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        #debugLogSection.active {
            max-height: 500px; /* ì¶©ë¶„í•œ ë†’ì´ */
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center items-center min-h-screen">

    <div id="app" class="w-full max-w-xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">ì—…ë¡œë“œ íŒŒì¼ ë‹¨ì–´ í•™ìŠµê¸°</h1>
        <p class="text-center text-sm text-gray-500 mb-6">
            <span id="loadStatusMessage" class="font-bold text-indigo-600">ë°ì´í„° ë¡œë”© ì¤‘...</span>
        </p>

        <!-- ë””ë²„ê·¸ ë¡œê·¸ (ì˜¤ë¥˜ ë°œìƒ ì‹œ í‘œì‹œ) -->
        <div id="debugLogSection">
            <div class="card p-4 border-l-4 border-red-500 bg-red-100">
                <p class="font-bold text-red-700 flex items-center mb-2">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜ ìƒì„¸
                </p>
                <pre id="debugLogContent" class="text-xs text-red-800 whitespace-pre-wrap font-mono"></pre>
            </div>
        </div>


        <!-- ë‹¨ì–´ í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div id="testSection" class="card p-6 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">ë‹¨ì–´ í…ŒìŠ¤íŠ¸ (<span id="progressText">0/0</span>)</h2>

            <!-- í˜„ì¬ ë‹¨ì–´ í‘œì‹œ -->
            <div id="wordDisplay" class="text-center bg-gray-100 p-6 rounded-lg mb-6 border-b-4 border-gray-200">
                <div class="text-sm font-medium text-gray-500">ë‹¨ì–´</div>
                <div id="currentWord" class="text-4xl font-extrabold text-green-600 mt-1"></div>
                <div id="wordContext" class="text-xs text-gray-400 mt-2"></div>
            </div>

            <!-- ì‚¬ìš©ì ì…ë ¥ ë° ê²°ê³¼ -->
            <input
                type="text"
                id="userAnswer"
                class="w-full p-4 border-2 border-indigo-300 rounded-lg text-lg text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-indigo-200 mb-4"
                placeholder="ì—¬ê¸°ì— ëœ»ì„ ì…ë ¥í•˜ì„¸ìš” (Enter í‚¤ë¡œ í™•ì¸)"
                onkeypress="if(event.key === 'Enter') checkAnswer()"
            />

            <div class="flex gap-4">
                 <button
                    id="checkBtn"
                    class="w-1/2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg btn-primary"
                    onclick="checkAnswer()"
                >
                    ì •ë‹µ í™•ì¸
                </button>
                <button
                    id="skipBtn"
                    class="w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg btn-primary"
                    onclick="skipWord()"
                >
                    ê±´ë„ˆë›°ê¸° (ì •ë‹µ ê³µê°œ)
                </button>
            </div>

            <!-- ë©”ì‹œì§€ ëª¨ë‹¬ (Alert ëŒ€ì²´) -->
            <div id="messageModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
                <div class="card p-6 w-full max-w-sm text-center transform transition-all duration-300">
                    <h3 id="modalTitle" class="text-2xl font-bold mb-3"></h3>
                    <p id="modalBody" class="text-gray-600 mb-6 whitespace-pre-line"></p>
                    <button class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg btn-primary" onclick="closeModal()">í™•ì¸</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =========================
        // ê¸€ë¡œë²Œ ë³€ìˆ˜ ë° DOM ìš”ì†Œ
        // =========================
        let vocabularyData = [];
        let currentIndex = -1;
        let currentWord = null;

        // CSV í—¤ë” ì´ë¦„ (ì‚¬ìš©ìë‹˜ì˜ íŒŒì¼ êµ¬ì¡°ì™€ ì¼ì¹˜)
        const HEADER_MAP = {
            CHAPTER: 'Chapter',
            TYPE: 'Type',
            WORD: 'Word',
            MEANING: 'Meaning'
        };

        const loadStatusMessage = document.getElementById('loadStatusMessage');
        const testSection = document.getElementById('testSection');
        const debugLogSection = document.getElementById('debugLogSection');
        const debugLogContent = document.getElementById('debugLogContent');
        const currentWordDiv = document.getElementById('currentWord');
        const wordContextDiv = document.getElementById('wordContext');
        const userAnswerInput = document.getElementById('userAnswer');
        const progressText = document.getElementById('progressText');
        
        const modal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        // ì‚¬ìš©ìë‹˜ê»˜ì„œ ì—…ë¡œë“œí•˜ì‹  íŒŒì¼ì˜ ë‚´ë¶€ ì ‘ê·¼ ê²½ë¡œ
        // ì´ ê²½ë¡œë¥¼ í†µí•´ ì™¸ë¶€ ì ‘ê·¼ ì—†ì´ íŒŒì¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const LOCAL_CSV_PATH = '/files/vocabulary_data.csv';

        // =========================
        // í—¬í¼ í•¨ìˆ˜
        // =========================

        /** ë””ë²„ê·¸ ë¡œê·¸ë¥¼ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤. */
        function updateDebugLog(message, isError = false) {
            debugLogContent.textContent = message;
            if (isError) {
                debugLogSection.classList.add('active');
                loadStatusMessage.classList.remove('text-indigo-600');
                loadStatusMessage.classList.add('text-red-500');
                loadStatusMessage.textContent = 'âŒ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨. ì•„ë˜ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
            } else {
                debugLogSection.classList.remove('active');
                loadStatusMessage.classList.remove('text-red-500');
                loadStatusMessage.classList.add('text-indigo-600');
            }
        }

        /**
         * ê°„ë‹¨í•œ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤ (alert() ëŒ€ì²´)
         */
        function showModal(title, body, onClose = null) {
            modalTitle.textContent = title;
            modalBody.textContent = body;
            modal.classList.remove('hidden');
            
            const closeHandler = () => {
                closeModal();
                if (onClose) onClose();
                modal.removeEventListener('click', modalClickListener);
            };

            // ëª¨ë‹¬ ë‚´ë¶€ì—ì„œ 'í™•ì¸' ë²„íŠ¼ì´ë‚˜ ëª¨ë‹¬ ë°°ê²½ì„ í´ë¦­í–ˆì„ ë•Œë§Œ ë‹«íˆë„ë¡ ì²˜ë¦¬
            const modalClickListener = (event) => {
                if (event.target.tagName === 'BUTTON' || event.target.id === 'messageModal') {
                    closeHandler();
                }
            };
            modal.addEventListener('click', modalClickListener);
        }

        /** ëª¨ë‹¬ì„ ë‹«ìŠµë‹ˆë‹¤. */
        function closeModal() {
            modal.classList.add('hidden');
        }

        /**
         * ë°°ì—´ì„ ë¬´ì‘ìœ„ë¡œ ì„ìŠµë‹ˆë‹¤. (Fisher-Yates ì•Œê³ ë¦¬ì¦˜)
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // =========================
        // ë°ì´í„° ì²˜ë¦¬ ë¡œì§
        // =========================

        /**
         * CSV í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (ë”°ì˜´í‘œë¡œ ê°ì‹¸ì§„ í•„ë“œ ì²˜ë¦¬ ê°œì„ )
         * @param {string} csvText - ë¶ˆëŸ¬ì˜¨ CSV íŒŒì¼ì˜ ë‚´ìš©
         * @returns {Array<Object>} íŒŒì‹±ëœ ë‹¨ì–´ ë°ì´í„° ë°°ì—´
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length <= 1) return []; 
            
            // í—¤ë” ì¶”ì¶œ ë° ì •ë¦¬
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            const data = [];

            // ì •ê·œì‹: ë”°ì˜´í‘œë¡œ ê°ì‹¸ì§„ í•„ë“œ ("...") ë˜ëŠ” ì‰¼í‘œê°€ ì•„ë‹Œ í•„ë“œ (non-comma)ë¥¼ ì°¾ìŒ
            const csvRegex = /(".*?"|[^",]+)(?=\s*,|\s*$)/g; 

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = line.match(csvRegex) || [];
                
                if (values.length !== headers.length) {
                    console.warn(`[CSV Skip] Line ${i + 1} column count mismatch. Expected ${headers.length}, got ${values.length}. Line: ${line}`);
                    continue; 
                }

                const row = {};
                headers.forEach((key, index) => {
                    let value = values[index] ? values[index].trim() : '';
                    // ìŒë”°ì˜´í‘œ ì œê±° (ì˜ˆ: "n.íê¸°ë¬¼, ë‚­ë¹„ " -> n.íê¸°ë¬¼, ë‚­ë¹„ )
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.substring(1, value.length - 1);
                    }
                    row[key] = value.trim();
                });
                
                // ë‹¨ì–´ì™€ ëœ»ì´ ëª¨ë‘ ìˆëŠ” ìœ íš¨í•œ í–‰ë§Œ ì €ì¥
                if (row[HEADER_MAP.WORD] && row[HEADER_MAP.MEANING]) {
                    data.push(row);
                }
            }
            return data;
        }

        /**
         * ë‚´ë¶€ íŒŒì¼ ê²½ë¡œì—ì„œ CSV íŒŒì¼ì„ ê°€ì ¸ì™€ íŒŒì‹±í•©ë‹ˆë‹¤. (ìë™ ì‹¤í–‰)
         */
        async function loadData() {
            updateDebugLog('íŒŒì¼ì„ ë‚´ë¶€ì ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', false);

            try {
                // ë¡œì»¬ íŒŒì¼ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ìš”ì²­ (CORS ë¬¸ì œ í•´ê²°)
                const response = await fetch(LOCAL_CSV_PATH);
                
                if (!response.ok) {
                    const errorDetails = `íŒŒì¼ ê²½ë¡œ: ${LOCAL_CSV_PATH}\nHTTP ìƒíƒœ ì½”ë“œ: ${response.status} ${response.statusText}\n(ì—…ë¡œë“œëœ íŒŒì¼ëª…ê³¼ ê²½ë¡œê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.)`;
                    throw new Error(errorDetails);
                }
                
                // íŒŒì¼ ë‚´ìš©ì„ í…ìŠ¤íŠ¸ë¡œ ì½ì–´ì˜µë‹ˆë‹¤.
                const csvText = await response.text();
                
                // CSV íŒŒì‹±
                vocabularyData = parseCSV(csvText);
                
                if (vocabularyData.length === 0) {
                    updateDebugLog(`íŒŒì¼ì—ì„œ ìœ íš¨í•œ ë‹¨ì–´ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í—¤ë” ë˜ëŠ” ë‚´ìš© í™•ì¸ í•„ìš”)\n\n-- íŒŒì¼ ì‹œì‘ ë¶€ë¶„ --\n${csvText.substring(0, 500)}...`, true);
                    return;
                }

                loadStatusMessage.textContent = `âœ… ì´ ${vocabularyData.length}ê°œì˜ ë‹¨ì–´ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`;
                updateDebugLog(`ë°ì´í„° ë¡œë“œ ì„±ê³µ: ${vocabularyData.length}ê°œ í•­ëª© ë¡œë“œë¨.`, false);

                // ë°ì´í„° ë¡œë“œ ì„±ê³µ í›„ í…ŒìŠ¤íŠ¸ ì‹œì‘
                startTest();

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë””ë²„ê·¸ ë¡œê·¸ì— í‘œì‹œ
                updateDebugLog(`âŒ ë°ì´í„° ë¡œë“œ/íŒŒì‹± ì‹¤íŒ¨:\n${error.message}`, true);
            }
        }

        // =========================
        // í…ŒìŠ¤íŠ¸ ë¡œì§
        // =========================

        /**
         * í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ê³  ë‹¤ìŒ ë‹¨ì–´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function startTest() {
            testSection.classList.remove('hidden');
            shuffleArray(vocabularyData); 
            currentIndex = -1; 
            userAnswerInput.value = '';
            userAnswerInput.focus();
            nextWord();
        }

        /**
         * ë‹¤ìŒ ë‹¨ì–´ë¥¼ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function nextWord() {
            currentIndex++;
            
            if (currentIndex >= vocabularyData.length) {
                showModal('í…ŒìŠ¤íŠ¸ ì™„ë£Œ! ğŸŠ', `ì´ ${vocabularyData.length}ê°œì˜ ë‹¨ì–´ í…ŒìŠ¤íŠ¸ë¥¼ ë§ˆì³¤ìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.`, startTest);
                return;
            }

            currentWord = vocabularyData[currentIndex];
            currentWordDiv.textContent = currentWord[HEADER_MAP.WORD];
            
            // Chapterì™€ Type ì •ë³´ë¥¼ contextì— í‘œì‹œí•˜ì—¬ íŒíŠ¸ ì œê³µ
            const chapter = currentWord[HEADER_MAP.CHAPTER] ? `Chapter ${currentWord[HEADER_MAP.CHAPTER]}` : '';
            const type = currentWord[HEADER_MAP.TYPE] || '';
            wordContextDiv.textContent = `${chapter}${chapter && type ? ' | ' : ''}${type}`;

            userAnswerInput.value = '';
            userAnswerInput.focus();
            userAnswerInput.style.borderColor = '#93c5fd'; 
            progressText.textContent = `${currentIndex + 1}/${vocabularyData.length}`;
        }

        /**
         * ì‚¬ìš©ìì˜ ì •ë‹µì„ í™•ì¸í•©ë‹ˆë‹¤.
         */
        function checkAnswer() {
            if (!currentWord || !userAnswerInput.value.trim()) {
                userAnswerInput.focus();
                return;
            }

            const userAnswer = userAnswerInput.value.trim();
            const correctMeaning = currentWord[HEADER_MAP.MEANING].trim();
            
            // 1. ê³µë°±, í’ˆì‚¬, ê´„í˜¸ ë“± ì •ë¦¬í•˜ëŠ” ì •ê·œí™” í•¨ìˆ˜
            const normalize = (text) => {
                return text.toLowerCase()
                    .replace(/\([^)]*\)/g, '') // ê´„í˜¸ì™€ ê´„í˜¸ ì•ˆì˜ ë‚´ìš© ì œê±°
                    .replace(/n\.|v\.|a\.|ad\.|etc\.|conj\./g, '') // í’ˆì‚¬ í‘œê¸° ì œê±°
                    .replace(/[\s\.\,\/]/g, '') // ëª¨ë“  ê³µë°±, ë§ˆì¹¨í‘œ, ì‰¼í‘œ, ìŠ¬ë˜ì‹œ ì œê±°
                    .trim();
            };

            const normalizedUserAnswer = normalize(userAnswer);
            
            // ì •ë‹µì„ ì‰¼í‘œ ë˜ëŠ” ìŠ¬ë˜ì‹œë¡œ ë¶„ë¦¬í•˜ì—¬ ê° ë¶€ë¶„ì„ í™•ì¸í•©ë‹ˆë‹¤.
            const correctParts = correctMeaning.split(/[,\/]/).map(part => normalize(part));

            // ì‚¬ìš©ì ë‹µì•ˆì´ ì •ë‹µ ë¶€ë¶„ ì¤‘ í•˜ë‚˜ë¼ë„ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ (ê°€ì¥ ìœ ì—°í•œ ê²€ì‚¬)
            // ì˜ˆë¥¼ ë“¤ì–´, ì •ë‹µì´ "íê¸°ë¬¼, ë‚­ë¹„"ì¼ ë•Œ ì‚¬ìš©ìê°€ "ë‚­ë¹„"ë§Œ ì…ë ¥í•´ë„ ì •ë‹µìœ¼ë¡œ ì¸ì •
            const isCorrect = correctParts.some(part => part === normalizedUserAnswer);


            if (isCorrect) {
                showModal('ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰', `ë‹¨ì–´: ${currentWord[HEADER_MAP.WORD]}\n\nì…ë ¥: ${userAnswer}\nì •ë‹µ: ${correctMeaning}`, nextWord);
                userAnswerInput.style.borderColor = '#10b981'; // ë…¹ìƒ‰
            } else {
                showModal('ì˜¤ë‹µì…ë‹ˆë‹¤! âŒ', `ì…ë ¥í•˜ì‹  ë‹µ: ${userAnswer}\n\nì •ë‹µ: ${correctMeaning}`);
                userAnswerInput.style.borderColor = '#ef4444'; // ë¹¨ê°„ìƒ‰
            }
        }

        /**
         * í˜„ì¬ ë‹¨ì–´ë¥¼ ê±´ë„ˆë›°ê³  ì •ë‹µì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
         */
        function skipWord() {
             if (!currentWord) return;
             showModal('ê±´ë„ˆë›°ê¸° (ì •ë‹µ)', `ë‹¨ì–´: ${currentWord[HEADER_MAP.WORD]}\nì •ë‹µ: ${currentWord[HEADER_MAP.MEANING]}`, nextWord);
             userAnswerInput.style.borderColor = '#fbbf24'; // ë…¸ë€ìƒ‰
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ë°ì´í„° ë¡œë“œë¥¼ ì‹œë„í•©ë‹ˆë‹¤.
        window.onload = loadData;
    </script>
</body>

</html>
