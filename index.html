<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>단어 테스트지 생성기</title>
    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* 커스텀 스타일 및 프린트 스타일 */
        @media print {
            body {
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .no-print,
            .controls,
            .header,
            #scrollTopButton,
            #scrollBottomButton {
                display: none !important;
            }

            @page {
                size: A4;
                margin: 10mm;
            }

            .print-area {
                page-break-after: always;
            }

            .question-block {
                page-break-inside: avoid;
            }

            .test-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px 16px;
            }

            .test-cell {
                border: 1px solid #000;
                padding: 6px;
                min-height: 60px;
            }
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px 16px;
        }

        .test-cell {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 10px;
            background-color: #ffffff;
        }

        #scrollTopButton,
        #scrollBottomButton {
            position: fixed;
            right: 1.25rem;
            z-index: 50;
        }

        #scrollTopButton {
            bottom: 4.5rem;
        }

        #scrollBottomButton {
            bottom: 1.25rem;
        }

        #loadingOverlay {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="header bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <span class="text-lg font-bold text-blue-600">목동유쌤영어학원</span>
                <span class="text-gray-400">|</span>
                <span class="text-sm text-gray-600">A4 출력용 랜덤 단어 테스트지 생성기</span>
            </div>
            <div class="flex items-center space-x-2 text-xs text-gray-400">
                <span>CSV 기반 자동 생성</span>
                <span>·</span>
                <span>GitHub Pages 호환</span>
            </div>
        </div>
    </header>

    <button id="scrollTopButton" class="no-print bg-blue-600 text-white rounded-full p-3 shadow-lg hover:bg-blue-700 transition hidden" aria-label="맨 위로">
        ▲
    </button>
    <button id="scrollBottomButton" class="no-print bg-blue-600 text-white rounded-full p-3 shadow-lg hover:bg-blue-700 transition hidden" aria-label="맨 아래로">
        ▼
    </button>

    <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="text-white text-xl p-4 bg-blue-600 rounded-lg shadow-lg">데이터 로딩 중...</div>
    </div>

    <main class="max-w-6xl mx-auto px-4 py-6">

        <div class="controls w-full max-w-4xl bg-white p-6 rounded-xl shadow-lg mb-6 sticky top-4 z-20">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">단어 테스트지 생성 옵션</h1>
            
            <div class="grid md:grid-cols-3 gap-4">
                <div class="multi-select-container" id="chapterSelectContainer">
                    <label for="chapterSelectButton" class="block text-sm font-medium text-gray-700 mb-1">챕터 선택 (다중 선택 가능)</label>
                    <button id="chapterSelectButton" disabled class="w-full flex justify-between items-center border border-gray-300 rounded-md px-3 py-2 bg-gray-50 text-sm text-gray-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-200 disabled:text-gray-500 disabled:cursor-not-allowed">
                        <span id="selectedChaptersText">데이터 로드 중...</span>
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div id="chapterSelectDropdown" class="absolute mt-1 w-72 bg-white border border-gray-200 rounded-md shadow-lg z-30 hidden max-h-60 overflow-y-auto">
                        <div class="px-3 py-2 border-b border-gray-100 flex items-center justify-between">
                            <span class="text-xs text-gray-500">원하는 챕터를 모두 선택하세요.</span>
                            <button id="selectAllChapters" class="text-xs text-blue-600 hover:underline">전체 선택</button>
                        </div>
                        <div id="chapterCheckboxList" class="py-1 text-sm text-gray-700 max-h-48 overflow-y-auto">
                        </div>
                    </div>
                </div>

                <div>
                    <label for="wordCount" class="block text-sm font-medium text-gray-700 mb-1">문항 수 (1~200)</label>
                    <input type="number" id="wordCount" min="1" max="200" value="40" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <p class="mt-1 text-xs text-gray-400">A4 기준 40~60문항 추천</p>
                </div>

                <div>
                    <label for="testType" class="block text-sm font-medium text-gray-700 mb-1">문제 유형</label>
                    <select id="testType" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="word-to-meaning">영어 → 뜻 쓰기</option>
                        <option value="meaning-to-word">뜻 → 영어 쓰기</option>
                        <option value="mixed">섞어서 출제</option>
                    </select>
                </div>
            </div>

            <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2">
                        <label class="text-xs font-medium text-gray-700">단어 유형:</label>
                        <select id="wordTypeFilter" class="border border-gray-300 rounded-md px-2 py-1 text-xs shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">전체</option>
                            <option value="표제어">표제어만</option>
                            <option value="파생어">파생어만</option>
                        </select>
                    </div>

                    <div class="flex items-center space-x-1">
                        <input type="checkbox" id="showNumbering" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <label for="showNumbering" class="text-xs text-gray-700">문항 번호 표시</label>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    <button id="generateButton" class="no-print inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-300 disabled:cursor-not-allowed">
                        테스트지 생성
                    </button>
                    <button id="printButton" class="no-print inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        인쇄하기 (Ctrl+P)
                    </button>
                </div>
            </div>

            <div id="statusMessage" class="mt-3 text-xs text-gray-500"></div>
            <div id="errorMessage" class="mt-1 text-xs text-red-500"></div>
        </div>

        <section id="testPaper" class="print-area bg-white p-6 rounded-xl shadow-md">
            <div class="text-center text-gray-400 text-sm">CSV 데이터를 로딩 중입니다...</div>
        </section>

        <section id="answerSheet" class="no-print mt-6 bg-white p-4 rounded-xl shadow-md">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-semibold text-gray-800">정답지 (미리보기용)</h2>
                <p class="text-xs text-gray-400">※ 실제 인쇄에는 포함되지 않습니다. 필요 시 별도 캡처 or 복사</p>
            </div>
            <div id="answerContent" class="text-sm text-gray-700 grid md:grid-cols-2 gap-x-8 gap-y-1">
            </div>
        </section>

    </main>

    <script type="module">
        let vocabularyData = [];
        let allChapters = [];
        const WORD_FILE_NAME = "word_data.csv";

        const loadingIndicator = document.getElementById('loadingOverlay');
        const chapterSelectDropdown = document.getElementById('chapterSelectDropdown');
        const chapterSelectButton = document.getElementById('chapterSelectButton');
        const chapterCheckboxList = document.getElementById('chapterCheckboxList');
        const selectAllChaptersButton = document.getElementById('selectAllChapters');
        const selectedChaptersText = document.getElementById('selectedChaptersText');
        const wordCountInput = document.getElementById('wordCount');
        const testTypeSelect = document.getElementById('testType');
        const wordTypeFilter = document.getElementById('wordTypeFilter');
        const showNumberingCheckbox = document.getElementById('showNumbering');
        const generateButton = document.getElementById('generateButton');
        const printButton = document.getElementById('printButton');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');
        const testPaper = document.getElementById('testPaper');
        const answerSheet = document.getElementById('answerSheet');
        const answerContent = document.getElementById('answerContent');

        const scrollTopButton = document.getElementById('scrollTopButton');
        const scrollBottomButton = document.getElementById('scrollBottomButton');
        const chapterSelectContainer = document.getElementById('chapterSelectContainer');

        /* =======================
           CSV 파서 (에러 방지 버전)
           ======================= */
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            const header = lines[0].split(',').map(h => h.trim());

            const chapterIndex = header.indexOf('Chapter');
            const typeIndex = header.indexOf('Type');
            const wordIndex = header.indexOf('Word');
            const meaningIndex = header.indexOf('Meaning');

            if ([chapterIndex, typeIndex, wordIndex, meaningIndex].includes(-1)) {
                throw new Error("CSV 헤더에 Chapter, Type, Word, Meaning 중 누락된 항목이 있습니다.");
            }

            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const columns = [];
                let current = '';
                let insideQuotes = false;

                for (let char of line) {
                    if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        columns.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                columns.push(current.trim());

                // ★ 열이 4개 미만이거나 인덱스가 없으면 해당 줄은 무시
                if (
                    columns.length <= chapterIndex ||
                    columns.length <= typeIndex ||
                    columns.length <= wordIndex ||
                    columns.length <= meaningIndex
                ) {
                    continue;
                }

                const chapter = parseInt(columns[chapterIndex], 10);
                const type = (columns[typeIndex] ?? '').trim();
                const word = (columns[wordIndex] ?? '').trim();
                const rawMeaning = (columns[meaningIndex] ?? '').trim();
                const meaning = rawMeaning.replace(/^"|"$/g, '');

                if (!word || !meaning || isNaN(chapter)) continue;

                data.push({
                    Chapter: chapter,
                    Type: type,
                    Word: word,
                    Meaning: meaning
                });
            }

            return data;
        }

        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function displayError(message) {
            errorMessage.textContent = message || '';
            if (message) console.error(message);
        }

        function displayStatus(message) {
            statusMessage.textContent = message || '';
        }

        async function loadData() {
            loadingIndicator.classList.remove('hidden');
            displayError(null);
            
            try {
                let fileUrl;
                if (window.getFileUrl) {
                    fileUrl = window.getFileUrl(WORD_FILE_NAME);
                } else {
                    fileUrl = WORD_FILE_NAME;
                }

                const response = await fetch(fileUrl);
                if (!response.ok) {
                    throw new Error(`파일을 로드하는 데 실패했습니다: ${response.statusText} (${response.status}). 파일이 올바르게 업로드되었는지 확인해주세요.`);
                }
                
                let csvText = await response.text();
                csvText = csvText.replace(/^\ufeff/, '');

                vocabularyData = parseCSV(csvText);

                if (vocabularyData.length === 0) {
                    throw new Error("CSV 파일에서 유효한 단어 데이터를 찾을 수 없습니다. 파일 내용 형식을 확인해주세요.");
                }
                
                allChapters = vocabularyData
                    .map(item => item.Chapter)
                    .filter(c => !isNaN(c));
                
                renderChapterDropdown();
                setupDropdownToggle(); 
                
                generateButton.disabled = false;
                
                console.log(`총 ${vocabularyData.length}개의 단어 로드 완료. (파일: ${WORD_FILE_NAME})`);
                
                generateTestPaper();

            } catch (error) {
                generateButton.disabled = true;
                chapterSelectButton.disabled = true;
                selectedChaptersText.textContent = '데이터 로드 오류';
                displayError('데이터 로드 중 오류가 발생했습니다: ' + error.message);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function renderChapterDropdown() {
            const uniqueChapters = Array.from(new Set(allChapters.filter(c => !isNaN(c))));
            const sortedChapters = uniqueChapters.sort((a, b) => a - b);

            chapterCheckboxList.innerHTML = '';

            if (sortedChapters.length === 0) {
                const noDataDiv = document.createElement('div');
                noDataDiv.className = 'px-3 py-2 text-xs text-gray-500';
                noDataDiv.textContent = '선택 가능한 챕터가 없습니다.';
                chapterCheckboxList.appendChild(noDataDiv);
                return;
            }

            sortedChapters.forEach(chapter => {
                const id = `chapter_${chapter}`;
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center px-3 py-1 hover:bg-gray-50';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = id;
                checkbox.value = chapter;
                checkbox.className = 'chapter-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded';
                checkbox.checked = true;

                const label = document.createElement('label');
                label.htmlFor = id;
                label.className = 'ml-2 text-sm text-gray-700';
                label.textContent = `Chapter ${chapter}`;

                wrapper.appendChild(checkbox);
                wrapper.appendChild(label);
                chapterCheckboxList.appendChild(wrapper);
            });

            updateSelectedChaptersText();

            chapterCheckboxList.addEventListener('change', () => {
                updateSelectedChaptersText();
            });

            selectAllChaptersButton.addEventListener('click', (e) => {
                e.preventDefault();
                const checkboxes = chapterCheckboxList.querySelectorAll('.chapter-checkbox');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !allChecked);
                updateSelectedChaptersText();
            });

            chapterSelectButton.disabled = false;
        }

        function updateSelectedChaptersText() {
            const selected = Array.from(document.querySelectorAll('.chapter-checkbox:checked')).map(cb => parseInt(cb.value, 10));
            if (selected.length === 0) {
                selectedChaptersText.textContent = '선택된 챕터 없음';
            } else if (selected.length === allChapters.length) {
                selectedChaptersText.textContent = '전체 챕터 선택';
            } else {
                selectedChaptersText.textContent = `선택된 챕터: ${selected.join(', ')}`;
            }

            const checkboxes = chapterCheckboxList.querySelectorAll('.chapter-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            selectAllChaptersButton.textContent = allChecked ? '전체 해제' : '전체 선택';
        }

        function setupDropdownToggle() {
            chapterSelectButton.addEventListener('click', () => {
                const isHidden = chapterSelectDropdown.classList.contains('hidden');
                if (isHidden) {
                    chapterSelectDropdown.classList.remove('hidden');
                } else {
                    chapterSelectDropdown.classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (!chapterSelectContainer.contains(e.target)) {
                    chapterSelectDropdown.classList.add('hidden');
                }
            });
        }

        function getFilteredAndShuffledWords() {
            const selectedChapters = Array.from(document.querySelectorAll('.chapter-checkbox:checked')).map(cb => parseInt(cb.value, 10));
            const wordType = wordTypeFilter.value;
            const wordCount = parseInt(wordCountInput.value, 10);

            if (!selectedChapters.length) {
                throw new Error("최소 1개 이상의 챕터를 선택해야 합니다.");
            }

            if (!wordCount || wordCount <= 0) {
                throw new Error("문항 수는 1 이상이어야 합니다.");
            }

            let filtered = vocabularyData.filter(item => selectedChapters.includes(item.Chapter));

            if (wordType !== 'all') {
                filtered = filtered.filter(item => item.Type === wordType);
            }

            if (!filtered.length) {
                throw new Error("선택된 조건에 해당하는 단어가 없습니다. 챕터 또는 단어 유형 설정을 확인해주세요.");
            }

            const shuffled = shuffleArray(filtered);

            return shuffled.slice(0, Math.min(wordCount, shuffled.length));
        }

        function renderTestPaper(words) {
            const testType = testTypeSelect.value;
            const showNumbering = showNumberingCheckbox.checked;

            if (!words || !words.length) {
                testPaper.innerHTML = '<div class="text-center text-gray-400 text-sm">출력할 문제가 없습니다.</div>';
                answerContent.innerHTML = '';
                return;
            }

            const testCells = [];
            const answers = [];

            words.forEach((item, index) => {
                const number = index + 1;
                const word = item.Word;
                const meaning = item.Meaning;

                let questionText = '';
                let answerText = '';

                if (testType === 'word-to-meaning') {
                    questionText = word;
                    answerText = `${number}. ${word} → ${meaning}`;
                } else if (testType === 'meaning-to-word') {
                    questionText = meaning;
                    answerText = `${number}. ${meaning} → ${word}`;
                } else if (testType === 'mixed') {
                    if (index % 2 === 0) {
                        questionText = word;
                        answerText = `${number}. ${word} → ${meaning}`;
                    } else {
                        questionText = meaning;
                        answerText = `${number}. ${meaning} → ${word}`;
                    }
                }

                const cellHtml = `
                    <div class="test-cell question-block">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                ${showNumbering ? `<span class="text-xs text-gray-500 mr-1">${number}.</span>` : ''}
                                <span class="font-medium text-gray-800">${questionText}</span>
                            </div>
                            <div class="w-24 border-b border-gray-300 ml-2"></div>
                        </div>
                        <div class="mt-2 text-xs text-gray-400">
                            <span class="mr-2 text-gray-400">[Chap ${item.Chapter}]</span>
                            <span class="text-gray-400">${item.Type}</span>
                        </div>
                    </div>
                `;

                testCells.push(cellHtml);
                answers.push(answerText);
            });

            const gridHtml = `
                <div class="test-grid">
                    ${testCells.join('')}
                </div>
            `;

            const countedByChapter = words.reduce((acc, cur) => {
                acc[cur.Chapter] = (acc[cur.Chapter] || 0) + 1;
                return acc;
            }, {});

            const chapterSummary = Object.entries(countedByChapter)
                .sort((a, b) => Number(a[0]) - Number(b[0]))
                .map(([ch, cnt]) => `Ch${ch}: ${cnt}문항`)
                .join(', ');

            const metaHtml = `
                <div class="mb-4 flex justify-between items-center">
                    <div class="text-sm font-semibold text-gray-800">랜덤 단어 테스트</div>
                    <div class="text-xs text-gray-500">${new Date().toLocaleDateString()}</div>
                </div>
                <div class="mb-4 flex items-center justify-between text-xs text-gray-500">
                    <div>총 ${words.length}문항 | 챕터 분포: ${chapterSummary}</div>
                    <div>문제 유형: ${
                        testType === 'word-to-meaning' ? '영어 → 뜻 쓰기' :
                        testType === 'meaning-to-word' ? '뜻 → 영어 쓰기' : '섞어서 출제'
                    }</div>
                </div>
            `;

            testPaper.innerHTML = metaHtml + gridHtml;

            answerContent.innerHTML = answers
                .map(ans => `<div>${ans}</div>`)
                .join('');
        }

        function generateTestPaper() {
            try {
                displayError(null);
                const words = getFilteredAndShuffledWords();
                renderTestPaper(words);
                displayStatus(`총 ${words.length}문항이 랜덤으로 생성되었습니다.`);
            } catch (error) {
                displayError(error.message);
                displayStatus('');
            }
        }

        window.addEventListener('scroll', () => {
            const scrollY = window.scrollY || document.documentElement.scrollTop;
            const docHeight = document.documentElement.scrollHeight - window.innerHeight;

            if (scrollY > 200) {
                scrollTopButton.classList.remove('hidden');
            } else {
                scrollTopButton.classList.add('hidden');
            }

            if (scrollY < docHeight - 200) {
                scrollBottomButton.classList.remove('hidden');
            } else {
                scrollBottomButton.classList.add('hidden');
            }
        });

        scrollTopButton.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        scrollBottomButton.addEventListener('click', () => {
            window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
        });

        generateButton.addEventListener('click', () => {
            generateTestPaper();
        });

        printButton.addEventListener('click', () => {
            window.print();
        });

        wordCountInput.addEventListener('change', () => {
            displayStatus('옵션이 변경되었습니다. "테스트지 생성" 버튼을 눌러 새로 생성하세요.');
        });
        testTypeSelect.addEventListener('change', () => {
            displayStatus('옵션이 변경되었습니다. "테스트지 생성" 버튼을 눌러 새로 생성하세요.');
        });
        wordTypeFilter.addEventListener('change', () => {
            displayStatus('옵션이 변경되었습니다. "테스트지 생성" 버튼을 눌러 새로 생성하세요.');
        });
        showNumberingCheckbox.addEventListener('change', () => {
            displayStatus('옵션이 변경되었습니다. "테스트지 생성" 버튼을 눌러 새로 생성하세요.');
        });

        window.addEventListener('DOMContentLoaded', () => {
            loadData();
        });

    </script>
</body>
</html>
